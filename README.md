<div align="center">

![HTML5](https://img.shields.io/badge/HTML5-E34F26?style=for-the-badge&logo=html5&logoColor=white)
![JavaScript](https://img.shields.io/badge/JavaScript_ES6-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black)
![Three.js](https://img.shields.io/badge/Three.js_r128-000000?style=for-the-badge&logo=three.js&logoColor=white)
![License](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)

# LOS 飛行訓練模擬器 Pro

**開源 Web-based 四軸飛行器目視（Line-of-Sight）飛行訓練模擬器**

模擬真實 5 吋 FPV 四軸飛行器的飛行物理，採用 Betaflight 風格的 Rates 系統，
在瀏覽器中練習從起飛懸停到 8 字飛行的完整技能。純前端、零安裝、即開即飛。

[**在線試玩 Live Demo**](https://m72900024.github.io/-Flight-Simulator-third-person-view/)

</div>

---

## 快速開始

1. 開啟 [Live Demo](https://m72900024.github.io/-Flight-Simulator-third-person-view/)
2. 點擊 **「以鍵盤開始」**
3. 選擇 **第 1 關**
4. 按 `Space` 解鎖馬達（Arm）
5. 按住 `W` 推油門起飛！

> 建議初學者先使用 **Alt Hold 模式**（按 `4`），油門中位自動定高，更容易上手。

---

## 功能特色

### 真實物理模擬

- 模擬 **600g 5 吋 FPV 四軸飛行器**，最大推力 28N
- **Betaflight 風格 Rates 系統**：基礎 Rate 1.2、SuperRate 0.7，最高角速度約 720°/s
- **油門 Expo 指數曲線**（Expo 0.3）：低油門細膩、高油門有力
- 二次方空氣阻力（drag coefficient 0.04）與角速度阻尼（angular drag 8.0）
- 真實地面碰撞：高速撞地彈跳（70% 能量損耗）、隨機旋轉、紅閃 + 鏡頭抖動回饋
- 50m 軟頂限制，防止飛出可視範圍

### 4 種飛行模式

涵蓋從初學到進階的完整訓練路徑（詳見下方說明）。

### 8 個循序漸進訓練關卡

從基礎起飛定高，到穿門、8 字飛行、綜合挑戰，逐步培養飛行技能。

### 精緻 3D 場景

- Three.js 即時 3D 渲染，PCFSoft 陰影系統（2048×2048 shadow map）
- 場景物件：25 棵隨機樹木、3 棟建築、圍欄、H 型降落場、風向袋
- 無人機模型：4 臂架構、紅藍馬達、旋轉螺旋槳（轉速隨油門變化）、LED 指示燈
- 第三人稱 LOS 視角：固定觀察點（模擬站在場地看飛機），攝影機平滑跟隨

### 雙輸入支援

- **鍵盤**：即開即玩，按住油門飛行、放開自然下降
- **搖桿**：支援 Gamepad API（RadioMaster、Xbox 手把等），可自訂通道映射、反轉、中點與端點校正

### 進度系統

- 關卡解鎖：過關自動解鎖下一關
- 最佳成績記錄（localStorage 持久化儲存）
- 即時進度條與完成時間顯示

---

## 操作方式

### 鍵盤控制

| 按鍵 | 功能 | 說明 |
|------|------|------|
| `W` | 油門升 | 按住持續增加油門（+240%/s），放開指數衰減（時間制，幀率獨立） |
| `S` | 油門降 | 瞬間油門歸零 |
| `↑` / `↓` | 俯仰 | 前進 / 後退傾斜 |
| `←` / `→` | 橫滾 | 左右傾斜 |
| `A` / `D` | 偏航 | 左右轉向（Yaw） |
| `Shift` | 精準模式 | 按住時操控量 ×0.4（降低靈敏度，精細操控） |
| `Space` | Arm / Disarm | 解鎖或鎖定馬達（防連發，不會自動重複） |
| `1` | Angle 模式 | 自穩模式 |
| `2` | Horizon 模式 | 半自穩模式 |
| `3` | Acro 模式 | 手動模式 |
| `4` | Alt Hold 模式 | 定高模式 |
| `R` | 重置 | 重置無人機位置與姿態 |
| `K` | 切換輸入 | 鍵盤 ↔ 搖桿模式切換 |
| `ESC` | 離開 | 遊戲中返回關卡選擇；關卡選擇中返回設定畫面 |

### 搖桿控制

支援標準 Gamepad API 搖桿（如 RadioMaster Zorro/Boxer/TX16S、Xbox 手把等）。

| 功能 | 預設軸 | 範圍 | 說明 |
|------|--------|------|------|
| 油門 | Axis 2 | 0.0 ~ 1.0 | 原始值 [-1, 1] 映射至 [0, 1] |
| 偏航 | Axis 0 | -1.0 ~ 1.0 | 左右轉向 |
| 俯仰 | Axis 1 | -1.0 ~ 1.0 | 前後傾斜 |
| 橫滾 | Axis 3 | -1.0 ~ 1.0 | 左右傾斜 |
| Arm | Axis 4 | > 0.5 解鎖 | 開關型 |
| 模式 | Axis 5 | 4 段切換 | -1.0 Angle / -0.5 Horizon / 0.0 Acro / 0.5+ Alt Hold |

**校正功能：**

- 所有軸支援反轉設定
- 死區（Deadzone）：5%（微小雜訊自動過濾）
- 中點校正：記錄搖桿中立位置作為零點
- 端點校正：記錄 Min / Max 值，自動映射至完整範圍

---

## 飛行模式說明

### Angle 模式（自穩）— 按 `1`

| 參數 | 值 |
|------|-----|
| 最大傾角 | 55° |
| 穩定方式 | 四元數 SLERP（因子 5.0 × dt） |
| 偏航控制 | 角速度（最大速率 50%） |
| 特性 | 鬆桿自動回正，搖桿映射目標角度 |

**適合對象：** 初學者入門。搖桿映射傾斜角度而非角速度，放手就回平。

### Horizon 模式（混合）— 按 `2`

| 參數 | 值 |
|------|-----|
| 混合公式 | `搖桿量³`（三次方曲線） |
| 中位 | 接近 Angle 模式（自穩） |
| 滿桿 | 接近 Acro 模式（角速度控制） |
| 角度修正 | 比例回饋 `(0 - 角度) × 5.0` |

**適合對象：** 進階練習。中位有自穩保護，滿桿可做翻滾等動作。

### Acro 模式（手動）— 按 `3`

| 參數 | 值 |
|------|-----|
| 基礎速率 | 600° × rates（1.2）= 720°/s |
| SuperRate | 0.7（滿桿額外加速） |
| 速率公式 | `baseRate × |stick| + baseRate × superRate × |stick|³` |
| 角速度阻尼 | `rotVel.lerp(target, 5 × dt)` |

**適合對象：** 高手挑戰。純角速度控制，無自動回正，必須手動修正所有姿態。

### Alt Hold 模式（定高）— 按 `4`

| 參數 | 值 |
|------|-----|
| 懸停推力 | mass × gravity = 5.886N |
| 油門死區 | 40% ~ 60%（中位） |
| 中位行為 | PD 控制器精確定高（kP=8, kD=5×mass），鎖定目標高度不飄移 |
| 高於 60% | 爬升：`hover + (input - 0.6) / 0.4 × thrustPower × 0.5` |
| 低於 40% | 下降：`hover × (1 - (0.4 - input) / 0.4 × 0.8)` |
| 姿態控制 | 同 Angle 模式 |

**適合對象：** 最簡單的模式。油門中位自動維持高度，專注練習方向控制。

---

## 訓練關卡

| 關卡 | 名稱 | 任務目標 | 過關條件 |
|------|------|----------|----------|
| 1 | 起飛定高 | 起飛並維持 2~3m 高度 | 在目標高度維持 3 秒（離開目標區計時器僅 ×0.5 速度倒扣，較寬容） |
| 2 | 定點懸停 | 在綠色方框內懸停 | 方框內（±1.25m）穩定 3 秒 |
| 3 | 前後平移 | 飛到前方 10m 標記點再返回 | 依序觸及兩個航點（距離 < 1.8m） |
| 4 | 左右平移 | 依序飛到左方與右方標記點 | 依序觸及兩個航點（距離 < 1.8m） |
| 5 | 矩形航線 | 依序飛過 4 個航點完成矩形 | 依序觸及 4 個航點（距離 < 1.8m） |
| 6 | 穿越拱門 | 穿越前方的大型環形門 | 通過拱門中心（距離 < 2m） |
| 7 | 8 字飛行 | 繞兩根柱子畫 8 字形航線 | 依序通過 6 個檢查點（距離 < 2.5m） |
| 8 | 綜合挑戰 | 穿 3 道門 + 4 個航點 + 返回降落場 | 依序完成所有目標（距離 < 1.8m） |

- 過關後自動解鎖下一關
- 成績（用時秒數）自動記錄到瀏覽器 localStorage
- 即時進度條顯示完成百分比

---

## 技術架構

### 技術棧

| 技術 | 說明 |
|------|------|
| **Three.js r128** | 3D 渲染引擎（CDN 載入，無需安裝） |
| **JavaScript ES6 Modules** | 模組化架構，原生 `import/export` |
| **Gamepad API** | 搖桿輸入支援 |
| **localStorage** | 成績與解鎖資料持久化 |
| **GitHub Pages** | 靜態部署，無需後端 |

無需 npm、bundler 或任何建置工具，直接開啟 `index.html` 即可運行。

### 檔案結構

```
├── index.html              # 主頁面 + UI 樣式 + 設定畫面 + 關卡選擇 + HUD
└── src/
    ├── Config.js           # 物理參數、飛行模式定義、8 關卡資料
    ├── Input.js            # 鍵盤/搖桿輸入（校正、死區、通道映射）
    ├── Physics.js          # 物理引擎（推力、重力、阻力、碰撞、姿態控制）
    ├── Scene.js            # 3D 場景（環境物件、無人機模型、燈光、攝影機）
    ├── LevelManager.js     # 關卡管理（目標生成、勝利判定、解鎖系統）
    └── main.js             # 主遊戲迴圈、UI 更新、事件調度
```

### 物理引擎參數

以下為 `Config.js` 定義的核心物理參數：

| 參數 | 值 | 說明 |
|------|-----|------|
| `gravity` | 9.81 m/s² | 重力加速度 |
| `mass` | 0.6 kg | 無人機質量（模擬 5 吋機） |
| `maxThrust` | 28.0 N | 四馬達最大推力 |
| `dragCoeff` | 0.04 | 二次方空氣阻力係數 |
| `angularDrag` | 8.0 | 角速度阻尼係數 |
| `hardDeck` | 0.05 m | 地面碰撞高度閾值 |
| `maxHeight` | 50 m | 軟頂限制高度 |
| `thrustPower` | 18 | 推力縮放因子 |
| `thrustExpo` | 0.3 | 油門 Expo 曲線權重 |
| `rates` | 1.2 | 基礎角速率倍數 |
| `superRate` | 0.7 | 滿桿加速因子 |
| `maxTiltAngle` | 55° | 自穩模式最大傾角 |
| `droneScale` | 3.0 | 無人機視覺縮放倍率 |

### 物理更新迴圈

每幀（dt 上限 0.1s）依序計算：

1. **推力計算**：油門輸入 → Expo 曲線 → 推力向量（沿無人機本地上方向）
2. **外力合成**：推力 + 重力（`-mass × gravity`）+ 空氣阻力（`-dragCoeff × speed²`）
3. **速度與位置積分**：`velocity += acceleration × dt` → `position += velocity × dt`
4. **地面碰撞處理**：高速撞地彈跳（`vel.y × -0.3`）、側向衰減、隨機旋轉擾動
5. **姿態控制**：依飛行模式計算目標角速度，四元數插值更新姿態
6. **軟頂限制**：超過 50m 高度時 `vel.y × 0.95` 逐漸減速

### 渲染系統

- **燈光**：半球光（天地雙色）+ 方向光（帶陰影）+ 環境光
- **陰影**：PCFSoft 柔邊陰影，解析度 2048×2048
- **霧效**：指數霧 `FogExp2`（密度 0.005），自然淡出遠景
- **效能**：像素比上限 2x、霧效減少遠景渲染負擔
- **螺旋槳動畫**：葉片轉速 `0.5 + throttle × 2.0 rad/frame`，碟面透明度隨油門變化

---

## 更新日誌

### v2.1（2026-03-01）

- **Shift 精準模式修正**：Shift 鍵改為降低靈敏度（操控量 ×0.4），精細操控而非加速
- **Alt Hold PD 控制器**：定高模式改用 PD 高度控制器（kP=8, kD=5×mass），精確鎖定高度不飄移
- **第 1 關寬容度提升**：離開目標高度時計時器倒扣速度由 ×2 降為 ×0.5，更容易過關
- **ESC 返回設定畫面**：在關卡選擇畫面按 ESC 可返回設定畫面
- **Space 防連發**：Space 鍵不再自動重複觸發，防止誤操作
- **幀率獨立油門**：油門增減與衰減改為時間制（基於 deltaTime），不同幀率下行為一致
- **撞地特效衰減修正**：crashIntensity 衰減改為幀率獨立（`Math.pow(0.92, dt×60)`）

### v2.0（2026-03-01）

- **場景升級**：精緻 3D 環境（25 棵樹木、3 棟建築、圍欄、H 型降落場、風向袋）
- **陰影系統**：PCFSoft 柔邊陰影（2048×2048 shadow map）
- **無人機模型**：四軸放大 3 倍，紅藍馬達、旋轉螺旋槳、LED 指示燈
- **LOS 視角**：固定觀察點第三人稱視角，攝影機平滑跟隨
- **8 關卡系統**：從起飛定高到綜合挑戰的完整訓練路徑
- **關卡選擇畫面**：顯示解鎖狀態與最佳成績
- **Alt Hold 定高模式**：油門中位自動維持高度，初學者友善
- **撞地回饋**：紅色閃光 + 攝影機抖動，衝擊力度正比於撞擊速度
- **俯仰方向修正**：修正搖桿俯仰映射方向
- **攝影機跟隨高度**：攝影機隨無人機高度平滑調整視角
- **關卡解鎖系統**：過關自動解鎖下一關，鎖定關卡灰化顯示
- **移除飛手模型**：簡化場景，消除視覺干擾
- **R 鍵重置功能**：一鍵重置無人機位置與姿態
- **運算子優先順序修正**：修正物理計算邏輯錯誤
- **定高標記可見度修正**：確保高度指示器在所有條件下正確顯示

### v1.1.0

- **搖桿端點校正**：支援 Min/Max 端點自動校正

### v1.0

- 基礎 LOS 飛行模擬
- Acro / Angle / Horizon 三種飛行模式
- 搖桿 + 鍵盤雙輸入支援
- 2 個基礎訓練關卡
- 真實 FPV 無人機造型
- 鍵盤油門（按住飛行、放開下降）
- 效能優化

---

## 本地開發

```bash
# 克隆專案
git clone https://github.com/m72900024/-Flight-Simulator-third-person-view.git
cd -Flight-Simulator-third-person-view

# 啟動本地伺服器（ES Modules 需要 HTTP 伺服器）
npx serve .
# 或
python3 -m http.server 8000
```

開啟瀏覽器前往 `http://localhost:8000` 即可。

> **注意**：由於使用 ES6 Modules，直接開啟 `index.html`（`file://` 協定）可能因 CORS 限制無法正常載入模組。請使用 HTTP 伺服器。

---

## 參與貢獻

歡迎任何形式的貢獻！

1. **Fork** 此專案
2. 建立功能分支：`git checkout -b feature/your-feature`
3. 提交變更：`git commit -m "feat: add your feature"`
4. 推送分支：`git push origin feature/your-feature`
5. 開啟 **Pull Request**

### 貢獻方向建議

- 新增訓練關卡
- 改善飛行物理模型
- 新增 FPV（第一人稱）視角模式
- 多語系支援
- 手機觸控控制
- 音效系統

---

## 授權

本專案採用 [MIT License](LICENSE) 授權。

---

<div align="center">

**[在線試玩](https://m72900024.github.io/-Flight-Simulator-third-person-view/)** · **[回報問題](https://github.com/m72900024/-Flight-Simulator-third-person-view/issues)** · **[參與貢獻](#參與貢獻)**

</div>
